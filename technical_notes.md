# claudeによるテクニカル・ノート

**Note: These documents are written in Japanese.**

## テクニカルノート: ChatGPT→Markdown変換システム

**by Claude (Anthropic)**

### 設計思想

このシステムは「単機能スクリプトの組み合わせ」という原則で作られています。モノリシックな実装が保守困難になった経験から、任天堂・岩田聡氏の「作り直し判断」に倣い、クリーンな再設計を行いました。

### アーキテクチャ

```
conversations.json
  ↓ split_conversations.py
raw/YYYY/MM/*.json + index.json
  ↓ to_markdown.py
individual.md
  ↓ batch_convert.py
markdown/YYYY/MM/*.md
```

各スクリプトは独立して動作し、前段の出力を入力として受け取ります。

### 技術的な判断

#### 1. データ構造の選択: 分割 vs 単一JSON

検討の結果、**分割方式**を採用しました。

**理由**:

- 部分処理の高速化（1スレッドだけのテスト、再処理）
- メモリ効率（1,200+スレッドを毎回読まない）
- デバッグの容易性
- 将来的な並列処理の余地

`index.json`で全体統計を保持することで、分割のデメリットを補完しています。

#### 2. Turn番号の0始まり

パーソナライゼーション読み込み等の「UI非表示メッセージ」対策として、Turn 0 を導入しました。

```python
turn_number: 0  # 内部処理では0始まり
if turn_number == 0:
    continue  # Markdown出力時はスキップ
```

これにより、特殊ケース処理を最小化しています。

#### 3. 空メッセージの扱い

`parts: []` の判定を `None` 返却で表現することで、スキップ対象を明示的にしました。

```python
if len(parts) == 0:
    return None  # スキップシグナル
```

この設計により、呼び出し側で統一的なスキップ処理が可能になります。

#### 4. 見出しレベルの調整

元メッセージの見出し構造を維持しつつ、Markdown階層に収めるため「`#`を1つ追加」という単純なルールを採用しました。

```
元: ## 見出し
→  ### 見出し（Turn配下に収まる）
```

複雑な見出し解析を避け、元の構造を尊重する判断です。

### データ構造の発見

開発前の分析で以下を発見しました：

- **12種類のcontent_type** が存在
- **role分布**: assistant 43.9%, user 34.6%, tool 13.5%, system 8.0%
- **create_timeの欠損**: systemで35%, userで4.8% → `metadata.timestamp_`で93.7%カバー可能
- **partsとtextの使い分け**: parts優先が86.4%

これらの知見が実装の精度を大きく向上させました。

### 相対パス設計

環境移行（MacBook→Mac Studio）を考慮し、すべてのパスを相対パスで処理しています。

```python
input_path.parent / output_base  # 絶対パス回避
```

### エラーハンドリング戦略

`batch_convert.py`では「エラーが出ても続行」方針を採用しました。

```python
try:
    generate_markdown(...)
except Exception as e:
    error_files.append(...)
    continue  # 次のファイルへ
```

1,200+ファイルの一括処理では、一部の失敗で全体が止まるのは非効率です。最後にエラーサマリーを表示することで、問題ファイルの特定を容易にしています。

### 今後の拡張性

現在の設計は以下の拡張を想定しています：

- 他フォーマット変換（`to_jsonl.py`, `to_html.py`）の追加
- 設定ファイル（`config.yaml`）による挙動カスタマイズ
- 並列処理の実装
- 差分更新（`index.json`のupdate_time活用）

単機能スクリプト方式により、これらの追加が既存コードに影響しません。

### 学び

「徹底的な分析→シンプルな設計→段階的実装」というアプローチが、1セッションでの完成を可能にしました。特に、データ構造を先に理解することで、実装中の方針変更を最小化できたことが大きかったです。

---

**Claude's Note**: このプロジェクトは、人間とAIの協働による「イチから作り直す」実践例でした。ユーザーの明確な要件定義と、段階的な確認プロセスが、エラーゼロでの完成に繋がりました。

[End of File]